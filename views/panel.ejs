<% const { arama, etiket, siraliGonderiler, kullaniciAdi }=locals; // HTML escape function defined once at the top
    function escapeHtml(text) { if (!text) return '' ; const map={ '&' : '&amp;' , '<' : '&lt;' , '>' : '&gt;' , '"'
    : '&quot;' , "'" : '&#039;' }; return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
    %>

    <%- include('header', Object.assign({}, locals, { title: 'Ana Akƒ±≈ü' })) %>

        <style>
            .feed-container {
                background: #f8f9fa;
                min-height: 100vh;
                padding: 40px 0;
            }

            .feed-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 25px;
                padding: 40px;
                margin-bottom: 30px;
                box-shadow: 0 15px 50px rgba(102, 126, 234, 0.25);
                position: relative;
                overflow: hidden;
            }

            .feed-header::before {
                content: "";
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
                animation: pulse 15s ease-in-out infinite;
            }

            @keyframes pulse {

                0%,
                100% {
                    transform: scale(1);
                    opacity: 0.5;
                }

                50% {
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }

            .feed-title {
                color: white;
                font-weight: 800;
                font-size: 2.8rem;
                margin-bottom: 15px;
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                position: relative;
                z-index: 1;
            }

            .feed-subtitle {
                color: rgba(255, 255, 255, 0.9);
                font-size: 1.1rem;
                margin-bottom: 25px;
                position: relative;
                z-index: 1;
            }

            .search-box {
                background: white;
                border-radius: 20px;
                padding: 25px;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
                border: 1px solid #e9ecef;
            }

            .search-input {
                border: 2px solid #e0e0e0;
                border-radius: 12px;
                padding: 12px 18px;
                transition: all 0.3s;
                font-size: 14px;
            }

            .search-input:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                outline: none;
            }

            .btn-gradient {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
                color: white;
                border-radius: 12px;
                padding: 12px 30px;
                font-weight: 600;
                transition: all 0.3s;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .btn-gradient:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                color: white;
            }

            .new-post-btn {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                border: none;
                color: white;
                border-radius: 50px;
                padding: 16px 45px;
                font-weight: 700;
                font-size: 17px;
                box-shadow: 0 10px 30px rgba(245, 87, 108, 0.35);
                transition: all 0.3s;
                text-decoration: none;
                display: inline-block;
                position: relative;
                z-index: 1;
            }

            .new-post-btn:hover {
                transform: translateY(-3px) scale(1.02);
                box-shadow: 0 15px 40px rgba(245, 87, 108, 0.45);
                color: white;
            }

            .post-card {
                background: white;
                border-radius: 25px;
                overflow: hidden;
                margin-bottom: 30px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
                transition: all 0.3s;
                border: 1px solid #f0f0f0;
                animation: fadeInUp 0.6s ease;
            }

            .post-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 50px rgba(102, 126, 234, 0.15);
                border-color: #667eea;
            }

            .post-header {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                padding: 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #e0e0e0;
            }

            .post-author {
                display: flex;
                align-items: center;
                gap: 12px;
                text-decoration: none;
                color: #333;
                font-weight: 600;
                transition: all 0.2s;
            }

            .post-author:hover {
                color: #667eea;
            }

            .author-avatar {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 18px;
                cursor: pointer;
            }

            .post-body {
                padding: 25px;
            }

            .post-content {
                color: #333;
                line-height: 1.6;
                font-size: 15px;
                word-wrap: break-word;
            }

            .hashtag {
                color: #667eea;
                text-decoration: none;
                font-weight: 600;
            }

            .hashtag:hover {
                color: #764ba2;
                text-decoration: underline;
            }

            .post-footer {
                padding: 20px 25px;
                background: #f8f9fa;
                border-top: 1px solid #e9ecef;
            }

            .action-buttons {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
            }

            .btn-like {
                border-radius: 50px;
                padding: 10px 25px;
                font-weight: 600;
                transition: all 0.3s;
                border: 2px solid #ff6b6b;
                background: white;
                color: #ff6b6b;
                text-decoration: none;
                display: inline-block;
            }

            .btn-like:hover {
                background: #ff6b6b;
                color: white;
                transform: scale(1.05);
            }

            .btn-like.liked {
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            }

            .btn-comment {
                border-radius: 50px;
                padding: 10px 25px;
                font-weight: 600;
                transition: all 0.3s;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
            }

            .btn-comment:hover {
                background: #667eea;
                color: white;
                transform: scale(1.05);
            }

            .comment-form {
                margin-top: 20px;
                display: flex;
                gap: 10px;
            }

            .comment-input {
                flex: 1;
                border: 2px solid #e0e0e0;
                border-radius: 25px;
                padding: 12px 20px;
                transition: all 0.3s;
            }

            .comment-input:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                outline: none;
            }

            .btn-send-comment {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                border: none;
                color: white;
                border-radius: 25px;
                padding: 10px 25px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .btn-send-comment:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            }

            .comments-section {
                margin-top: 20px;
                padding-top: 20px;
                border-top: 2px solid #e9ecef;
            }

            .comment-item {
                background: white;
                border-left: 4px solid #667eea;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 12px;
                transition: all 0.2s;
            }

            .comment-item:hover {
                background: #f8f9fa;
                border-left-color: #764ba2;
            }

            .comment-author {
                font-weight: 700;
                color: #667eea;
                margin-right: 8px;
            }

            .comment-text {
                color: #444;
                margin: 5px 0;
                word-wrap: break-word;
            }

            .comment-time {
                font-size: 11px;
                color: #999;
            }

            .empty-state {
                background: white;
                border-radius: 25px;
                padding: 80px 50px;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
                border: 2px dashed #e0e0e0;
            }

            .empty-state-icon {
                font-size: 100px;
                margin-bottom: 25px;
                opacity: 0.4;
                animation: float 3s ease-in-out infinite;
            }

            @keyframes float {

                0%,
                100% {
                    transform: translateY(0px);
                }

                50% {
                    transform: translateY(-20px);
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .post-image-container {
                margin: 15px -25px;
                background: #000;
                max-height: 500px;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .post-image {
                max-width: 100%;
                max-height: 500px;
                object-fit: contain;
                transition: transform 0.5s;
            }

            .post-image:hover {
                transform: scale(1.02);
            }
        </style>

        <div class="feed-container">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="feed-header text-center">
                            <h1 class="feed-title">üè† Ana Akƒ±≈ü</h1>
                            <p class="feed-subtitle">Arkada≈ülarƒ±nƒ±zƒ±n payla≈üƒ±mlarƒ±nƒ± ke≈üfedin</p>
                            <a href="/gonderi/yeni" class="new-post-btn">
                                ‚ú® Yeni G√∂nderi Payla≈ü
                            </a>
                        </div>

                        <div class="search-box mb-4">
                            <form action="/panel" method="GET">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <input type="text" name="arama" class="form-control search-input"
                                            placeholder="üîç G√∂nderi i√ßeriƒüinde ara..." value="<%= arama || '' %>">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" name="etiket" class="form-control search-input"
                                            placeholder="üè∑Ô∏è #Etiket ara..." value="<%= etiket || '' %>">
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-gradient w-100" type="submit">Ara</button>
                                    </div>
                                </div>

                                <% if (arama || etiket) { %>
                                    <div class="text-center mt-3">
                                        <a href="/panel" class="text-decoration-none"
                                            style="color: #667eea; font-weight: 600;">
                                            ‚úï Filtreleri Temizle
                                        </a>
                                    </div>
                                    <% } %>
                            </form>
                        </div>

                        <% if (siraliGonderiler.length===0) { %>
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <h3 style="color: #667eea; font-weight: 700;">Hen√ºz G√∂nderi Yok</h3>
                                <p style="color: #999; font-size: 16px;">ƒ∞lk g√∂nderiyi sen payla≈ü ve topluluƒüu
                                    canlandƒ±r!</p>
                                <a href="/gonderi/yeni" class="new-post-btn mt-3">
                                    üöÄ Hemen G√∂nderi Payla≈ü
                                </a>
                            </div>
                            <% } %>

                                <% siraliGonderiler.forEach((gonderi, index)=> { %>
                                    <% const kullaniciBegenmisMi=gonderi.begeniler.includes(kullaniciAdi); const
                                        authorInitial=gonderi.yazar.charAt(0).toUpperCase(); let
                                        icerikHTML=escapeHtml(gonderi.icerik);
                                        icerikHTML=icerikHTML.replace(/#(\w+)/g, '<a href="/panel?arama=&etiket=%23$1" class="hashtag">#$1</a>'
                                        ); %>

                                        <div class="post-card" style="animation-delay: <%= index * 0.1 %>s;">
                                            <div class="post-header">
                                                <a href="/profil/<%= gonderi.yazar %>" class="post-author">
                                                    <div class="author-avatar">
                                                        <%= authorInitial %>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 16px;">@<%= gonderi.yazar %>
                                                        </div>
                                                        <small style="color: #999; font-size: 12px;">
                                                            <%= gonderi.zaman %>
                                                        </small>
                                                    </div>
                                                </a>
                                            </div>

                                            <div class="post-body">
                                                <p class="post-content"><%- icerikHTML %></p>
                                                <% if (gonderi.resimUrl) { %>
                                                    <div class="post-image-container">
                                                        <img src="<%= escapeHtml(gonderi.resimUrl) %>"
                                                            alt="G√∂nderi Resmi" class="post-image"
                                                            onerror="this.parentElement.style.display='none'">
                                                    </div>
                                                    <% } %>
                                            </div>

                                            <div class="post-footer">
                                                <div class="action-buttons">
                                                    <a href="/gonderi/like/<%= gonderi.id %>"
                                                        class="btn btn-like <%= kullaniciBegenmisMi ? 'liked' : '' %>">
                                                        ‚ù§Ô∏è <%= kullaniciBegenmisMi ? 'Beƒüendin' : 'Beƒüen' %> ¬∑ <%=
                                                                gonderi.begeniler.length %>
                                                    </a>

                                                    <button class="btn btn-comment" type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#yorumlar-<%= gonderi.id %>">
                                                        üí¨ Yorumlar ¬∑ <%= gonderi.yorumlar.length %>
                                                    </button>
                                                </div>

                                                <form action="/gonderi/yorum/<%= gonderi.id %>" method="POST"
                                                    class="comment-form">
                                                    <input type="text" name="yorumIcerik" class="comment-input"
                                                        placeholder="D√º≈ü√ºncelerini payla≈ü..." required>
                                                    <button class="btn btn-send-comment" type="submit">G√∂nder</button>
                                                </form>

                                                <div class="collapse comments-section" id="yorumlar-<%= gonderi.id %>">

                                                    <% if (gonderi.yorumlar.length> 0) { %>
                                                        <% const tersYorumlar=gonderi.yorumlar.slice().reverse(); %>
                                                            <% tersYorumlar.forEach(yorum=> { %>
                                                                <div class="comment-item">
                                                                    <span class="comment-author">@<%= yorum.yazar %>
                                                                            </span>
                                                                    <span class="comment-text">
                                                                        <%= escapeHtml(yorum.icerik) %>
                                                                    </span>
                                                                    <div class="comment-time">
                                                                        <%= yorum.zaman %>
                                                                    </div>
                                                                </div>
                                                                <% }); %>
                                                                    <% } else { %>
                                                                        <div
                                                                            style="text-align: center; padding: 30px; color: #999;">
                                                                            <div
                                                                                style="font-size: 40px; margin-bottom: 10px;">
                                                                                üí≠</div>
                                                                            <p>Hen√ºz yorum yok. ƒ∞lk yorumu sen yap!</p>
                                                                        </div>
                                                                        <% } %>

                                                </div>
                                            </div>
                                        </div>
                                        <% }); %>

                    </div>
                </div>
            </div>
        </div>

        <%- include('footer') %>