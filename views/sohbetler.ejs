<% const { arkadaslar, mevcutKullaniciAdi, aktifSohbetler }=locals; %>

  <%- include('header', Object.assign({}, locals, { title: 'Sohbetler' })) %>

    <style>
      .page-container {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 40px 0;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 25px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 15px 50px rgba(0, 242, 254, 0.25);
        color: white;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .chat-header::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: pulse 15s ease-in-out infinite;
      }

      .chat-list {
        background: white;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .chat-item {
        display: flex;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
        text-decoration: none;
        color: #333;
        transition: background 0.2s;
      }

      .chat-item:hover {
        background: #f8f9fa;
      }

      .chat-item:last-child {
        border-bottom: none;
      }

      .chat-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 20px;
        border: 2px solid #e0e0e0;
      }

      .chat-info {
        flex: 1;
        min-width: 0;
      }

      .chat-name {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-meta {
        font-size: 0.8rem;
        color: #999;
        font-weight: 400;
      }

      .chat-preview {
        color: #666;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 5px;
      }

      .btn-create-group {
        display: block;
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        border-radius: 15px;
        text-decoration: none;
        font-weight: 700;
        margin-bottom: 20px;
        border: none;
        transition: transform 0.2s;
      }

      .btn-create-group:hover {
        transform: translateY(-3px);
        color: white;
      }

      .badge-group {
        background: #ffc107;
        color: #333;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 8px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        background-color: #ccc;
        border-radius: 50%;
        display: inline-block;
        margin-left: 5px;
        border: 2px solid white;
      }

      .status-dot.online {
        background-color: #28a745;
      }

      @keyframes pulse {

        0%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }

        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .user-select-list {
        max-height: 300px;
        overflow-y: auto;
      }
    </style>

    <div class="page-container">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <div class="chat-header">
              <h1 style="font-weight: 800; margin-bottom: 10px;">ðŸ’¬ Sohbetler</h1>
              <p style="opacity: 0.9; margin: 0;">Son konuÅŸmalarÄ±n ve gruplarÄ±n burada</p>
            </div>

            <button type="button" class="btn-create-group" data-bs-toggle="modal" data-bs-target="#createGroupModal">
              âœ¨ Yeni Grup OluÅŸtur
            </button>

            <div class="chat-list">
              <% if (aktifSohbetler && aktifSohbetler.length> 0) { %>
                <% aktifSohbetler.forEach(sohbet=> { %>
                  <a href="/sohbet/<%= sohbet.id %>" class="chat-item" id="chat-item-<%= sohbet.ad %>">
                    <div style="position: relative;">
                      <img src="<%= sohbet.profil %>" alt="<%= sohbet.ad %>" class="chat-avatar">
                      <% if (sohbet.tur==='dm' ) { %>
                        <span class="status-dot <%= sohbet.status === 'online' ? 'online' : '' %>"
                          id="status-<%= sohbet.ad %>" style="position: absolute; bottom: 0; right: 15px;"></span>
                        <% } %>
                    </div>
                    <div class="chat-info">
                      <div class="chat-name">
                        <span>
                          <%= sohbet.tur==='dm' ? '@' : '' %>
                            <%= sohbet.ad %>
                              <% if (sohbet.tur==='grup' ) { %>
                                <span class="badge-group">Grup</span>
                                <% } %>
                        </span>
                        <span class="chat-meta">
                          <%= sohbet.sonMesaj.zaman || '' %>
                        </span>
                      </div>
                      <div class="chat-preview">
                        <% if (sohbet.sonMesaj.gonderen) { %>
                          <strong>
                            <%= sohbet.sonMesaj.gonderen %>:
                          </strong>
                          <% } %>
                            <%= sohbet.sonMesaj.icerik || 'Mesaj yok' %>
                      </div>
                    </div>
                  </a>
                  <% }); %>
                    <% } else { %>
                      <div class="text-center p-5">
                        <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;">ðŸ“­</div>
                        <h3>HenÃ¼z bir sohbet yok</h3>
                        <p class="text-muted">ArkadaÅŸ listenizden birini seÃ§ip sohbete baÅŸlayÄ±n veya yeni bir grup
                          oluÅŸturun!</p>
                      </div>
                      <% } %>
            </div>

            <div class="mt-4 text-center">
              <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
                data-bs-target="#friendsCollapse">
                ðŸ‘¥ TÃ¼m ArkadaÅŸlarÄ± GÃ¶ster
              </button>

              <div class="collapse mt-3" id="friendsCollapse">
                <div class="card card-body">
                  <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <% if (arkadaslar && arkadaslar.length> 0) { %>
                      <% arkadaslar.forEach(ark=> { %>
                        <a href="/sohbet/<%= ark.kullaniciAdi %>" class="btn btn-sm btn-light border">
                          @<%= ark.kullaniciAdi %>
                        </a>
                        <% }); %>
                          <% } else { %>
                            <span class="text-muted">ArkadaÅŸÄ±nÄ±z yok.</span>
                            <% } %>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="/grup/olustur" method="POST">
            <div class="modal-header">
              <h5 class="modal-title">Yeni Grup OluÅŸtur</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Grup AdÄ±</label>
                <input type="text" name="grupAdi" class="form-control" placeholder="Ã–rn: Hafta Sonu PlanÄ±" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Ãœyeleri SeÃ§</label>
                <div class="user-select-list border p-2 rounded">
                  <% if (arkadaslar && arkadaslar.length> 0) { %>
                    <% arkadaslar.forEach(ark=> { %>
                      <div class="form-check p-2 border-bottom">
                        <input class="form-check-input" type="checkbox" name="uyeler[]" value="<%= ark.kullaniciAdi %>"
                          id="check_<%= ark.kullaniciAdi %>">
                        <label class="form-check-label d-flex align-items-center gap-2"
                          for="check_<%= ark.kullaniciAdi %>">
                          <img src="<%= ark.profilFotografi %>" style="width: 30px; height: 30px; border-radius: 50%;">
                          @<%= ark.kullaniciAdi %>
                        </label>
                      </div>
                      <% }); %>
                        <% } else { %>
                          <p class="text-center text-muted mt-3">Eklenecek arkadaÅŸÄ±nÄ±z yok.</p>
                          <% } %>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
              <button type="submit" class="btn btn-primary">OluÅŸtur</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const socket = io();

      socket.on('status_update', (data) => {
        const statusDot = document.getElementById('status-' + data.kullaniciAdi);
        if (statusDot) {
          if (data.status === 'online') {
            statusDot.classList.add('online');
          } else {
            statusDot.classList.remove('online');
          }
        }
      });
    </script>

    <%- include('footer') %>