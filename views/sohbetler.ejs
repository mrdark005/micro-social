<% 
const { mevcutKullaniciAdi, hedefKullaniciAdi, hedefProfil, mesajlar, roomId, mevcutProfil } = locals;
%>

<%
let body = '';

body += `
<style>
.chat-container {
display: flex;
height: calc(100vh - 80px);
max-width: 1400px;
margin: 0 auto;
background: white;
border-radius: 12px;
overflow: hidden;
box-shadow: 0 2px 20px rgba(0,0,0,0.1);
}

.chat-main {
flex: 1;
display: flex;
flex-direction: column;
}

.chat-header {
padding: 20px 25px;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
display: flex;
align-items: center;
justify-content: space-between;
}

.chat-header-info {
display: flex;
align-items: center;
gap: 15px;
}

.profile-pic {
width: 45px;
height: 45px;
border-radius: 50%;
object-fit: cover;
border: 3px solid white;
}

.chat-messages {
flex: 1;
overflow-y: auto;
padding: 25px;
background: #f5f5f5;
}

.date-separator {
text-align: center;
margin: 25px 0 15px;
position: relative;
}

.date-separator-line {
height: 1px;
background: linear-gradient(to right, transparent, #ddd, transparent);
}

.date-separator-text {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: #f5f5f5;
padding: 5px 15px;
color: #999;
font-size: 12px;
font-weight: 600;
border-radius: 15px;
border: 1px solid #e0e0e0;
}

.message-wrapper {
margin-bottom: 15px;
display: flex;
align-items: flex-end;
gap: 10px;
}

.message-wrapper.me {
flex-direction: row-reverse;
}

.message-avatar {
width: 35px;
height: 35px;
border-radius: 50%;
object-fit: cover;
}

.message-bubble {
max-width: 60%;
padding: 12px 16px;
border-radius: 18px;
box-shadow: 0 1px 2px rgba(0,0,0,0.1);
animation: slideIn 0.3s ease;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.message-bubble.me {
background: #667eea;
color: white;
border-bottom-right-radius: 4px;
}

.message-bubble.other {
background: white;
color: #333;
border-bottom-left-radius: 4px;
}

.message-text {
margin: 0;
word-wrap: break-word;
line-height: 1.4;
}

.message-time {
font-size: 11px;
opacity: 0.7;
margin-top: 4px;
}

.chat-input-wrapper {
padding: 20px 25px;
background: white;
border-top: 1px solid #e0e0e0;
}

.chat-input-form {
display: flex;
gap: 12px;
align-items: center;
}

.chat-input {
flex: 1;
border: 2px solid #e0e0e0;
border-radius: 25px;
padding: 12px 20px;
font-size: 14px;
transition: all 0.2s;
}

.chat-input:focus {
outline: none;
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.chat-send-btn {
width: 50px;
height: 50px;
border-radius: 50%;
border: none;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
cursor: pointer;
transition: all 0.2s;
display: flex;
align-items: center;
justify-content: center;
font-size: 20px;
}

.chat-send-btn:hover:not(:disabled) {
transform: scale(1.05);
box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.chat-send-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.connection-status {
position: fixed;
top: 20px;
right: 20px;
padding: 12px 20px;
border-radius: 8px;
font-size: 14px;
font-weight: 500;
z-index: 9999;
display: none;
animation: slideInRight 0.3s ease;
}

.connection-status.warning {
background: #ff9800;
color: white;
}

.connection-status.error {
background: #f44336;
color: white;
}

.connection-status.success {
background: #4caf50;
color: white;
}

@keyframes slideInRight {
from {
opacity: 0;
transform: translateX(100px);
}
to {
opacity: 1;
transform: translateX(0);
}
}
</style>

<div class="container mt-4">
    <div class="chat-container">
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-header-info">
                    <a href="/sohbet" class="btn btn-light btn-sm">‚Üê Geri</a>
                    <img src="${hedefProfil}" class="profile-pic" alt="${hedefKullaniciAdi}">
                    <div>
                        <h5 class="mb-0">@${hedefKullaniciAdi}</h5>
                        <small class="opacity-75">Sohbet</small>
                    </div>
                </div>
                <a href="/profil/${hedefKullaniciAdi}" class="btn btn-light btn-sm">
                    üë§ Profil
                </a>
            </div>

            <div class="chat-messages" id="mesajKutusu">
`;

function getDateLabel(dateStr) {
    if (!dateStr) return null;
    const msgDate = new Date(dateStr);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);

    msgDate.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    yesterday.setHours(0, 0, 0, 0);
    weekAgo.setHours(0, 0, 0, 0);

    if (msgDate.getTime() === today.getTime()) {
        return 'Bug√ºn';
    } else if (msgDate.getTime() === yesterday.getTime()) {
        return 'D√ºn';
    } else if (msgDate >= weekAgo) {
        return '1 Hafta √ñnce';
    } else {
        return msgDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
    }
}

let lastDateLabel = null;
mesajlar.forEach(mesaj => {
    const currentDateLabel = getDateLabel(mesaj.tarih);

    if (currentDateLabel && currentDateLabel !== lastDateLabel) {
        body += `
                <div class="date-separator">
                    <div class="date-separator-line"></div>
                    <div class="date-separator-text">${currentDateLabel}</div>
                </div>
        `;
        lastDateLabel = currentDateLabel;
    }

    const isMe = mesaj.gonderen === mevcutKullaniciAdi;
    const profilFoto = isMe ? (mevcutProfil || 'https://i.ibb.co/L9L1s1K/default-profile.png') : hedefProfil;

    body += `
                <div class="message-wrapper ${isMe ? 'me' : 'other'}">
    `;
    
    if (!isMe) {
        body += `<img src="${profilFoto}" class="message-avatar" alt="${mesaj.gonderen}">`;
    }
    
    body += `
                    <div class="message-bubble ${isMe ? 'me' : 'other'}">
                        <p class="message-text">${mesaj.icerik}</p>
                        <div class="message-time">${mesaj.zaman}</div>
                    </div>
    `;
    
    if (isMe) {
        body += `<img src="${profilFoto}" class="message-avatar" alt="Ben">`;
    }
    
    body += `
                </div>
    `;
});

body += `
            </div>

            <div class="chat-input-wrapper">
                <form class="chat-input-form" id="mesajFormu">
                    <input type="text" id="mesajIcerik" class="chat-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                        autocomplete="off" required>
                    <button class="chat-send-btn" type="submit" id="gonderButton" disabled>
                        ‚û§
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="connectionStatus" class="connection-status"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const mevcutKullaniciAdi = '${mevcutKullaniciAdi}';
    const hedefKullaniciAdi = '${hedefKullaniciAdi}';
    const roomId = '${roomId}';
    const mevcutProfil = "${mevcutProfil || 'https://i.ibb.co/L9L1s1K/default-profile.png'}";
    const hedefProfil = '${hedefProfil}';

    const mesajKutusu = document.getElementById('mesajKutusu');
    const mesajIcerikInput = document.getElementById('mesajIcerik');
    const gonderButton = document.getElementById('gonderButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const mesajFormu = document.getElementById('mesajFormu');

    function scrollBottom() {
        mesajKutusu.scrollTop = mesajKutusu.scrollHeight;
    }

    function showStatus(message, type) {
        connectionStatus.textContent = message;
        connectionStatus.className = 'connection-status ' + type;
        connectionStatus.style.display = 'block';

        if (type === 'success') {
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        }
    }

    function updateButtonState() {
        const hasContent = mesajIcerikInput.value.trim().length > 0;
        const isConnected = socket.connected;
        gonderButton.disabled = !hasContent || !isConnected;
    }

    function getDateLabel(dateStr) {
        if (!dateStr) return null;
        const msgDate = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);

        msgDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        yesterday.setHours(0, 0, 0, 0);
        weekAgo.setHours(0, 0, 0, 0);

        if (msgDate.getTime() === today.getTime()) {
            return 'Bug√ºn';
        } else if (msgDate.getTime() === yesterday.getTime()) {
            return 'D√ºn';
        } else if (msgDate >= weekAgo) {
            return '1 Hafta √ñnce';
        } else {
            return msgDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        }
    }

    let lastDateLabel = null;

    socket.on('connect', () => {
        console.log('[Socket] Baƒülandƒ±');
        socket.emit('join_chat_room', roomId);
        showStatus('‚úì Baƒülantƒ± kuruldu', 'success');
        mesajIcerikInput.disabled = false;
        updateButtonState();
        scrollBottom();
    });

    socket.on('disconnect', () => {
        console.log('[Socket] Baƒülantƒ± kesildi');
        showStatus('‚ö† Baƒülantƒ± kesildi. Yeniden baƒülanƒ±lƒ±yor...', 'warning');
        gonderButton.disabled = true;
        mesajIcerikInput.disabled = true;
    });

    socket.on('connect_error', (error) => {
        console.error('[Socket] Baƒülantƒ± hatasƒ±:', error);
        showStatus('‚ùå Sunucuya baƒülanƒ±lamƒ±yor!', 'error');
        gonderButton.disabled = true;
        mesajIcerikInput.disabled = true;
    });

    socket.on('receive_message', (mesaj) => {
        console.log('[Socket] Mesaj alƒ±ndƒ±:', mesaj);
        ekranaMesajEkle(mesaj);
        scrollBottom();
    });

    mesajFormu.addEventListener('submit', (e) => {
        e.preventDefault();

        const mesajIcerigi = mesajIcerikInput.value.trim();
        if (mesajIcerigi === '') return;

        if (!socket.connected) {
            showStatus('‚ùå Baƒülantƒ± yok!', 'error');
            return;
        }

        const anlikMesaj = {
            gonderen: mevcutKullaniciAdi,
            icerik: mesajIcerigi,
            zaman: new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
            tarih: new Date().toISOString()
        };

        ekranaMesajEkle(anlikMesaj);
        scrollBottom();

        socket.emit('send_message', {
            roomId: roomId,
            hedefKullaniciAdi: hedefKullaniciAdi,
            mesajIcerigi: mesajIcerigi
        });

        mesajIcerikInput.value = '';
        updateButtonState();
    });

    mesajIcerikInput.addEventListener('input', updateButtonState);

    mesajIcerikInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            mesajFormu.dispatchEvent(new Event('submit'));
        }
    });

    function ekranaMesajEkle(mesaj) {
        const currentDateLabel = getDateLabel(mesaj.tarih);

        if (currentDateLabel && currentDateLabel !== lastDateLabel) {
            const separatorHTML = `
                <div class="date-separator">
                    <div class="date-separator-line"></div>
                    <div class="date-separator-text">${currentDateLabel}</div>
                </div>
            `;
            mesajKutusu.insertAdjacentHTML('beforeend', separatorHTML);
            lastDateLabel = currentDateLabel;
        }

        const isMe = mesaj.gonderen === mevcutKullaniciAdi;
        const profilFoto = isMe ? mevcutProfil : hedefProfil;

        const guvenliIcerik = mesaj.icerik
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');

        const mesajHTML =  `
            <div class="message-wrapper ${isMe ? 'me' : 'other'}">
                ${!isMe ? `<img src="${profilFoto}" class="message-avatar" alt="${mesaj.gonderen}">` : ''}
                <div class="message-bubble ${isMe ? 'me' : 'other'}">
                    <p class="message-text">${guvenliIcerik}</p>
                    <div class="message-time">${mesaj.zaman}</div>
                </div>
                \${isMe ? \`<img src="\${profilFoto}" class="message-avatar" alt="Ben">\` : ''}
            </div>
        `;
        
        mesajKutusu.insertAdjacentHTML('beforeend', mesajHTML);
    }
    
    window.addEventListener('load', () => {
        scrollBottom();
        updateButtonState();
    });
</script>
`;
%>

<%- include('layout', { title: '@' + hedefKullaniciAdi + ' - Sohbet', body: body }) %>